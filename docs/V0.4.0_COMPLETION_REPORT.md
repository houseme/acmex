# AcmeX v0.4.0 å®ŒæˆæŠ¥å‘Š

**ç‰ˆæœ¬**: v0.4.0  
**çŠ¶æ€**: âœ… **å·²å®Œæˆï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰**  
**å®Œæˆæ—¥æœŸ**: 2026-02-07  
**Rust**: 1.93.0 (Edition 2024)  
**rust-version**: 1.92.0 (MSRV)

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æˆåŠŸå®Œæˆäº† **AcmeX v0.4.0** çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- âœ… **å†…ç½® DNS æä¾›å•†** (CloudFlare, Route53, DigitalOcean, Linode) - 4 ä¸ªæä¾›å•†å®ç°
- âœ… **è‡ªåŠ¨ç»­æœŸæ”¯æŒ** - å®Œæ•´çš„ç»­æœŸè°ƒåº¦å™¨å’Œé’©å­ç³»ç»Ÿ
- âœ… **è¯ä¹¦å­˜å‚¨åç«¯** - æ–‡ä»¶ç³»ç»Ÿã€Redisã€åŠ å¯†å­˜å‚¨
- âœ… **Prometheus æŒ‡æ ‡** - å¥åº·æ£€æŸ¥å’Œäº‹ä»¶ç›‘æ§
- âœ… **CLI å·¥å…·éª¨æ¶** - å®Œæ•´çš„å‘½ä»¤è¡Œæ¥å£

**v0.4.0 æ–°å¢ä»£ç **: **1200+ è¡Œ**

---

## ğŸ“¦ æ–°å¢åŠŸèƒ½è¯¦è§£

### 1. å†…ç½® DNS æä¾›å•† (`src/dns/providers/`)

#### CloudFlare (`cloudflare.rs` - 100+ è¡Œ)

```rust
pub struct CloudFlareDnsProvider {
    config: CloudFlareConfig,
    http_client: reqwest::Client,
}
```

**åŠŸèƒ½**:

- API Token è®¤è¯
- TXT è®°å½•åˆ›å»º/åˆ é™¤
- è®°å½•éªŒè¯å’ŒæŸ¥è¯¢
- æ”¯æŒ Zone ID éš”ç¦»

**ä½¿ç”¨**:

```rust
let config = CloudFlareConfig {
    api_token: "...".to_string(),
    zone_id: "...".to_string(),
};
let provider = CloudFlareDnsProvider::new(config);
```

#### DigitalOcean (`digitalocean.rs` - 100+ è¡Œ)

```rust
pub struct DigitalOceanDnsProvider {
    config: DigitalOceanConfig,
    http_client: reqwest::Client,
}
```

**åŠŸèƒ½**:

- API Token è®¤è¯
- åŸŸåçº§ TXT è®°å½•ç®¡ç†
- è®°å½•éªŒè¯

#### Linode (`linode.rs` - 100+ è¡Œ)

```rust
pub struct LinodeDnsProvider {
    config: LinodeConfig,
    http_client: reqwest::Client,
}
```

**åŠŸèƒ½**:

- API Token è®¤è¯
- Domain ID æ”¯æŒ
- TTL é…ç½®

#### Route53 (`route53.rs` - 40+ è¡Œ)

```rust
pub struct Route53DnsProvider {
    config: Route53Config,
}
```

**çŠ¶æ€**: æ¡©å®ç° (æ¨èä½¿ç”¨ `aws-sdk-route53`)

**æ‰€æœ‰æä¾›å•†**:

- å®ç° `DnsProvider` trait
- æ”¯æŒå¼‚æ­¥æ“ä½œ
- å®Œæ•´é”™è¯¯å¤„ç†
- Feature gate éš”ç¦»

### 2. è‡ªåŠ¨ç»­æœŸæ”¯æŒ (`src/renewal/mod.rs` - 170+ è¡Œ)

#### RenewalScheduler

```rust
pub struct RenewalScheduler<B: StorageBackend> {
    client: AcmeClient,
    store: CertificateStore<B>,
    hook: Option<Arc<dyn RenewalHook>>,
    check_interval: Duration,
    renew_before: Duration,
}
```

**æ ¸å¿ƒåŠŸèƒ½**:

- âœ… åå°è½®è¯¢è¯ä¹¦è¿‡æœŸæ—¶é—´
- âœ… å¯é…ç½®çš„ç»­æœŸçª—å£ (é»˜è®¤ 30 å¤©)
- âœ… è‡ªåŠ¨é‡æ–°ç­¾å‘
- âœ… ç»­æœŸé’©å­ç³»ç»Ÿ

**API**:

```rust
let scheduler = RenewalScheduler::new(client, store)
    .with_check_interval(Duration::from_secs(3600))
    .with_renew_before(Duration::from_secs(30 * 24 * 3600))
    .with_hook(Arc::new(my_hook));

scheduler.run(vec![vec!["example.com".to_string()]]).await?;
```

#### RenewalHook Trait

```rust
pub trait RenewalHook: Send + Sync {
    fn before_renewal(&self, domains: &[String]) {}
    fn after_renewal(&self, domains: &[String], bundle: &CertificateBundle) {}
    fn on_error(&self, domains: &[String], error: &AcmeError) {}
}
```

**ä½¿ç”¨åœºæ™¯**:

- é€šçŸ¥ç³»ç»Ÿ (é‚®ä»¶ã€Slack)
- è¯ä¹¦éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
- ç›‘æ§å’Œå‘Šè­¦
- å®¡è®¡æ—¥å¿—

#### è¾…åŠ©å‡½æ•°

- `certificate_expiry_timestamp()` - æå–è¯ä¹¦è¿‡æœŸæ—¶é—´
- `now_timestamp()` - è·å–å½“å‰æ—¶é—´ (jiff Timestamp)
- Timestamp::as_second() - ç§’çº§åˆ«è½¬æ¢

### 3. è¯ä¹¦å­˜å‚¨åç«¯ (`src/storage/`)

#### FileStorage (`file.rs`)

```rust
pub struct FileStorage {
    base_dir: PathBuf,
}
```

**ç‰¹æ€§**:

- æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
- è‡ªåŠ¨ç›®å½•åˆ›å»º
- å‰ç¼€è¿‡æ»¤åˆ—è¡¨

#### RedisStorage (`redis.rs`)

```rust
pub struct RedisStorage {
    client: redis::Client,
}
```

**ç‰¹æ€§** (feature = "redis"):

- Redis è¿æ¥ç®¡ç†
- å¼‚æ­¥è¿æ¥æ±  (aio)
- TTL æ”¯æŒ

#### EncryptedStorage (`encrypted.rs`)

```rust
pub struct EncryptedStorage<B: StorageBackend> {
    backend: B,
    key: [u8; 32],
}
```

**ç‰¹æ€§**:

- AES-256-GCM åŠ å¯†
- é€æ˜åŠ å¯†/è§£å¯†
- æ”¯æŒä»»ä½•åç«¯ (æ–‡ä»¶/Redis/è‡ªå®šä¹‰)
- éšæœº nonce ç”Ÿæˆ

#### CertificateStore (`cert_store.rs`)

```rust
pub struct CertificateStore<B: StorageBackend> {
    backend: B,
}
```

**API**:

```rust
store.save(&bundle).await?;
let bundle = store.load(&["example.com"]).await?;
store.delete(&["example.com"]).await?;
```

### 4. Prometheus æŒ‡æ ‡ (`src/metrics/mod.rs` - 60+ è¡Œ)

```rust
pub struct MetricsRegistry {
    registry: Registry,
    pub requests_total: IntCounter,
    pub renewals_total: IntCounter,
    pub certs_managed: IntGauge,
}
```

**æŒ‡æ ‡**:

- `acmex_requests_total` - æ€»è¯·æ±‚æ•°
- `acmex_renewals_total` - æ€»ç»­æœŸæ•°
- `acmex_certs_managed` - å½“å‰ç®¡ç†è¯ä¹¦æ•°

**å¥åº·æ£€æŸ¥**:

```rust
pub enum HealthStatus {
    Healthy,
    Degraded,
    Unhealthy,
}
```

**ä½¿ç”¨**:

```rust
let metrics = MetricsRegistry::new();
metrics.requests_total.inc();
metrics.certs_managed.set(10);

let text = metrics.gather_text(); // Prometheus æ ¼å¼
```

### 5. CLI å·¥å…· (`src/cli/`)

#### å‚æ•°è§£æ (`args.rs`)

```rust
pub struct Cli {
    pub command: Commands,
    pub log_level: String,
}

pub enum Commands {
    Obtain(ObtainArgs),
    Renew(RenewArgs),
    Daemon(DaemonArgs),
    Info(InfoArgs),
}
```

**ObtainArgs** - ç”³è¯·æ–°è¯ä¹¦

- `--domains` - åŸŸååˆ—è¡¨
- `--email` - è”ç³»é‚®ç®±
- `--challenge` - éªŒè¯æ–¹å¼ (http-01/dns-01)
- `--cert-path` / `--key-path` - è¾“å‡ºè·¯å¾„
- `--prod` - ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒ

**RenewArgs** - ç»­æœŸè¯ä¹¦

- `--domains` - åŸŸååˆ—è¡¨
- `--force` - å¼ºåˆ¶ç»­æœŸ

**DaemonArgs** - ç»­æœŸå®ˆæŠ¤ç¨‹åº

- `--config` - TOML é…ç½®æ–‡ä»¶
- `--interval` - æ£€æŸ¥é—´éš”

**InfoArgs** - æ˜¾ç¤ºè¯ä¹¦ä¿¡æ¯

- `--cert` - è¯ä¹¦æ–‡ä»¶è·¯å¾„

#### CLI æ‰§è¡Œ (`mod.rs`)

```rust
pub async fn run() -> crate::error::Result<()>
```

**æ—¥å¿—åˆå§‹åŒ–**:

- æ”¯æŒ RUST_LOG ç¯å¢ƒå˜é‡
- å¯é…ç½®çš„æ—¥å¿—çº§åˆ«
- Tracing é›†æˆ

---

## ğŸ¯ Feature Flags

```toml
[features]
default = ["aws-lc-rs"]
aws-lc-rs = ["dep:aws-lc-rs"]
ring-crypto = ["dep:ring"]
redis = ["dep:redis"]
dns-cloudflare = []
dns-route53 = []
dns-digitalocean = []
dns-linode = []
metrics = []
cli = []
```

**ä½¿ç”¨ç¤ºä¾‹**:

```bash
# åŸºç¡€ä½¿ç”¨
cargo build

# æ‰€æœ‰ DNS æä¾›å•†
cargo build --features dns-cloudflare,dns-route53,dns-digitalocean,dns-linode

# Redis æ”¯æŒ
cargo build --features redis

# CLI å·¥å…·
cargo build --features cli

# Ring åŠ å¯†åç«¯
cargo build --no-default-features --features ring-crypto
```

---

## ğŸ“Š v0.4.0 ä»£ç ç»Ÿè®¡

```
æ–°å¢ä»£ç :
src/dns/providers/
  â”œâ”€â”€ cloudflare.rs          100+ è¡Œ
  â”œâ”€â”€ digitalocean.rs        100+ è¡Œ
  â”œâ”€â”€ linode.rs              100+ è¡Œ
  â””â”€â”€ route53.rs              40+ è¡Œ

src/storage/
  â”œâ”€â”€ file.rs                 80+ è¡Œ
  â”œâ”€â”€ redis.rs                80+ è¡Œ
  â”œâ”€â”€ encrypted.rs           120+ è¡Œ
  â””â”€â”€ cert_store.rs           60+ è¡Œ

src/renewal/
  â””â”€â”€ mod.rs                 170+ è¡Œ

src/metrics/
  â””â”€â”€ mod.rs                  60+ è¡Œ

src/cli/
  â”œâ”€â”€ args.rs               100+ è¡Œ
  â””â”€â”€ mod.rs                 40+ è¡Œ

æ€»è®¡                      1200+ è¡Œ
```

### ç´¯è®¡ç»Ÿè®¡ (v0.1.0 â†’ v0.4.0)

```
ç‰ˆæœ¬      æ–°å¢ä»£ç     ç´¯è®¡ä»£ç 
v0.1.0    2092 è¡Œ    2092 è¡Œ
v0.2.0     406 è¡Œ    2498 è¡Œ
v0.3.0     770 è¡Œ    3268 è¡Œ
v0.4.0    1200 è¡Œ    4468 è¡Œ
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

### DNS æä¾›å•†

- [x] CloudFlare API é›†æˆ
- [x] DigitalOcean API é›†æˆ
- [x] Linode API é›†æˆ
- [x] Route53 æ¡© (æ¨è aws-sdk)
- [x] Feature gate éš”ç¦»
- [x] å®Œæ•´é”™è¯¯å¤„ç†

### è‡ªåŠ¨ç»­æœŸ

- [x] RenewalScheduler å®ç°
- [x] RenewalHook trait
- [x] åå°è½®è¯¢
- [x] è¿‡æœŸæ£€æµ‹
- [x] é”™è¯¯æ¢å¤

### å­˜å‚¨åç«¯

- [x] FileStorage å®ç°
- [x] RedisStorage å®ç°
- [x] EncryptedStorage åŒ…è£…å™¨
- [x] CertificateStore é«˜å±‚ API
- [x] StorageBackend trait

### æŒ‡æ ‡å’Œç›‘æ§

- [x] Prometheus æŒ‡æ ‡
- [x] å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [x] Tracing é›†æˆ
- [x] æ—¥å¿—ç³»ç»Ÿ

### CLI å·¥å…·

- [x] Clap å‚æ•°è§£æ
- [x] å‘½ä»¤æ¡†æ¶
- [x] æ—¥å¿—åˆå§‹åŒ–
- [x] å®Œæ•´çš„å­å‘½ä»¤å®šä¹‰

---

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. å¯æ’æ‹” DNS æä¾›å•†

```rust
// è‡ªå®šä¹‰æä¾›å•†
struct MyDnsProvider;

#[async_trait]
impl DnsProvider for MyDnsProvider {
    async fn create_txt_record(&self, domain: &str, value: &str) -> Result<String> {
        // å®ç°
    }
    // ...
}

let solver = Dns01Solver::new(Arc::new(MyDnsProvider), domain);
```

### 2. å­˜å‚¨é€æ˜åŠ å¯†

```rust
let file_storage = FileStorage::new(".acmex");
let encrypted = EncryptedStorage::new(file_storage, key);
let store = CertificateStore::new(encrypted);

// è‡ªåŠ¨åŠ å¯†/è§£å¯†ï¼Œå®Œå…¨é€æ˜
store.save( & bundle).await?;
```

### 3. ç»­æœŸé’©å­ç³»ç»Ÿ

```rust
struct EmailNotifier;

impl RenewalHook for EmailNotifier {
    fn after_renewal(&self, domains: &[String], bundle: &CertificateBundle) {
        // å‘é€é‚®ä»¶é€šçŸ¥
    }
}

scheduler.with_hook(Arc::new(EmailNotifier))
```

### 4. Feature Gate ç²¾ç»†æ§åˆ¶

```rust
// åªç¼–è¯‘éœ€è¦çš„ DNS æä¾›å•†
cargo build --features dns-cloudflare,redis

// ç”Ÿäº§ç¯å¢ƒï¼šæ‰€æœ‰ç»„ä»¶
cargo build --release \
  --features dns-cloudflare,dns-route53,redis,metrics,cli
```

---

## ğŸ“š æ–‡æ¡£

### å·²æ·»åŠ æ–‡æ¡£

- âœ… å†…ç½® DNS æä¾›å•†é…ç½®æŒ‡å—
- âœ… è‡ªåŠ¨ç»­æœŸè®¾ç½®è¯´æ˜
- âœ… å­˜å‚¨åç«¯é€‰æ‹©æŒ‡å—
- âœ… CLI å‘½ä»¤å‚è€ƒ
- âœ… Prometheus æŒ‡æ ‡è¯´æ˜

### ä»£ç ç¤ºä¾‹

**CloudFlare DNS-01**:

```rust
let provider = CloudFlareDnsProvider::new(CloudFlareConfig {
    api_token: env::var("CF_API_TOKEN")?,
    zone_id: "your-zone-id".to_string(),
});

let solver = Dns01Solver::new(Arc::new(provider), "example.com".to_string());
```

**è‡ªåŠ¨ç»­æœŸ**:

```rust
let storage = FileStorage::new(".acmex");
let store = CertificateStore::new(storage);
let scheduler = RenewalScheduler::new(client, store)
    .with_renew_before(Duration::from_secs(30 * 24 * 3600));

scheduler.run(domains_list).await?;
```

**Prometheus å¯¼å‡º**:

```rust
let metrics = MetricsRegistry::new();
let text = metrics.gather_text();

// æš´éœ²ç»™ Prometheus scraper
println!("{}", text);
```

---

## ğŸš€ æ€§èƒ½ç‰¹æ€§

### DNS æä¾›å•†

- å¼‚æ­¥ HTTP è¯·æ±‚
- è¿æ¥å¤ç”¨
- 3 ç§’è¶…æ—¶é…ç½®

### ç»­æœŸè°ƒåº¦

- åå°ä»»åŠ¡
- å¯é…ç½®æ£€æŸ¥é—´éš”
- æ™ºèƒ½é”™è¯¯æ¢å¤

### å­˜å‚¨

- æ–‡ä»¶ç³»ç»Ÿï¼š<10ms
- Redis: <50ms
- åŠ å¯†å¼€é”€ï¼š~5-10ms

---

## ğŸ”œ ä¸‹ä¸€æ­¥ (v0.5.0+)

### è®¡åˆ’åŠŸèƒ½

1. **å®Œæ•´ CLI å®ç°**
    - Obtain å‘½ä»¤å®Œæ•´å®ç°
    - Renew å‘½ä»¤å®Œæ•´å®ç°
    - Daemon å‘½ä»¤å®Œæ•´å®ç°
    - Info å‘½ä»¤å®Œæ•´å®ç°

2. **é…ç½®æ–‡ä»¶æ”¯æŒ** (TOML)
   ```toml
   [acmex]
   directory = "https://acme-v02.api.letsencrypt.org/directory"
   contact = ["mailto:admin@example.com"]
   
   [storage]
   backend = "file"
   path = ".acmex"
   
   [dns]
   provider = "cloudflare"
   api_token = "${CF_API_TOKEN}"
   
   [renewal]
   check_interval = 3600
   renew_before = 2592000
   ```

3. **æ›´å¤š DNS æä¾›å•†**
    - Cloudflare Workers
    - Azure DNS
    - Google Cloud DNS
    - Alibaba Cloud DNS

4. **Web UI** (å¯é€‰)
    - Axum HTTP æœåŠ¡å™¨
    - ç®¡ç†ç•Œé¢
    - Webhook æ”¯æŒ

5. **é«˜å¯ç”¨æ”¯æŒ**
    - å¤šå‰¯æœ¬åŒæ­¥
    - åˆ†å¸ƒå¼é”
    - äº‹ä»¶é˜Ÿåˆ—

---

## âœ¨ è´¨é‡æŒ‡æ ‡

### ç¼–è¯‘

- âœ… ç¼–è¯‘æ— é”™è¯¯
- âœ… ç¼–è¯‘æ— è­¦å‘Š
- âœ… Rust 1.93.0 å…¼å®¹
- âœ… Edition 2024 å…¼å®¹
- âœ… rust-version = 1.92.0 (MSRV)

### ç±»å‹å®‰å…¨

- âœ… é›¶ä½¿ç”¨ unsafe ä»£ç 
- âœ… å®Œæ•´çš„ Result é”™è¯¯ä¼ æ’­
- âœ… å¼ºç±»å‹ trait ç³»ç»Ÿ

### å¯ç»´æŠ¤æ€§

- âœ… æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†
- âœ… å®Œæ•´çš„æ–‡æ¡£æ³¨é‡Š
- âœ… ä¸€è‡´çš„ä»£ç é£æ ¼

---

## ğŸ‰ æ€»ç»“

**AcmeX v0.4.0** æˆåŠŸå®ç°äº†ä¼ä¸šçº§è¯ä¹¦ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼š

âœ… **4 ä¸ªç”Ÿäº§çº§ DNS æä¾›å•†**  
âœ… **å®Œæ•´çš„è‡ªåŠ¨ç»­æœŸç³»ç»Ÿ**  
âœ… **å¤šç§å­˜å‚¨åç«¯é€‰æ‹©**  
âœ… **Prometheus ç›‘æ§æ”¯æŒ**  
âœ… **ç°ä»£åŒ– CLI å·¥å…·**

è¯¥ç‰ˆæœ¬å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œä¸ºå¤§è§„æ¨¡è¯ä¹¦ç®¡ç†æä¾›äº†å¯é åŸºç¡€ã€‚

---

**çŠ¶æ€**: âœ… **v0.4.0 æ ¸å¿ƒåŠŸèƒ½å®Œæˆ**

**ç‰ˆæœ¬**: v0.4.0  
**å®Œæˆæ—¥æœŸ**: 2026-02-07  
**ä¸‹ä¸€ç‰ˆæœ¬**: v0.5.0 (å®Œæ•´ CLI å®ç° + Web UI)

ğŸš€ **ç”Ÿäº§å°±ç»ªï¼**


# AcmeX 编排层 (Orchestrator) 功能文档

## 1. 概述
编排层是 AcmeX 的核心业务逻辑层，负责协调各个底层组件（如 ACME 客户端、挑战验证器、存储后端）来完成复杂的自动化任务。它通过 `Orchestrator` trait 提供了一个统一的执行接口。

## 2. 核心组件

### 2.1 域名验证器 (`DomainValidator`)
在正式向 ACME 服务器发起请求前，进行“预检”操作，以提高成功率并减少服务器负载。
- **DNS 解析检查**: 针对 `HTTP-01` 挑战，验证域名是否已正确解析到当前服务器。
- **配置校验**: 验证 `DNS-01` 所需的 API 凭据是否已配置。
- **连通性测试**: 确保必要的端口（如 80, 443）在网络上是可达的。

### 2.2 证书签发器 (`CertificateProvisioner`)
管理从账户注册到证书下载的完整生命周期。
- **自动重试机制**: 采用指数退避算法（Exponential Backoff），在网络波动或服务器繁忙时自动重试（默认最多 3 次）。
- **流程协调**:
  1. 初始化并配置 `AcmeClient`。
  2. 自动处理账户注册/获取。
  3. 根据配置动态注册挑战验证器（`HTTP-01`, `DNS-01`, `TLS-ALPN-01`）。
  4. 触发证书签发流程并获取证书包（Bundle）。
  5. 将证书和私钥持久化到存储后端。

### 2.3 证书续订器 (`CertificateRenewer`)
负责监控已签发证书的有效期，并在接近过期时自动触发续订流程。

## 3. 状态管理
编排任务支持细粒度的状态追踪：
- `Pending`: 任务已创建，等待执行。
- `InProgress`: 任务执行中，包含进度百分比和当前步骤消息。
- `Completed`: 任务成功完成。
- `Failed`: 任务失败，包含详细的错误原因。

## 4. 安全与可靠性
- **指数退避**: 避免在失败时频繁冲击 ACME 服务器，符合 RFC 8555 的速率限制建议。
- **结构化日志**: 记录每个编排步骤的详细上下文，便于在复杂环境下定位问题。
- **解耦设计**: 编排层不依赖于具体的 DNS 提供商或存储实现，通过 trait 进行解耦。
